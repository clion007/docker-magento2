#!/bin/bash
set -e

/usr/bin/mysqld_safe &

# wait for mysql
until mysql -u root &> /dev/null
do
  printf "."
  sleep 1
done

mysql -u root -e "
	CREATE DATABASE $M2SETUP_DB_NAME;
	CREATE USER '$M2SETUP_DB_USER'@'$M2SETUP_DB_HOST' IDENTIFIED BY '$M2SETUP_DB_PASSWORD';
	GRANT ALL PRIVILEGES ON *.* TO '$M2SETUP_DB_USER'@'$M2SETUP_DB_HOST';
"

# Configure composer
[ ! -z "${COMPOSER_GITHUB_TOKEN}" ] && \
    composer config --global github-oauth.github.com $COMPOSER_GITHUB_TOKEN

[ ! -z "${COMPOSER_MAGENTO_USERNAME}" ] && \
    composer config --global http-basic.repo.magento.com \
        $COMPOSER_MAGENTO_USERNAME $COMPOSER_MAGENTO_PASSWORD

#composer require community-engineering/language-de_de --no-update
#composer install 
magento-installer

echo "saving database to /dump.sql"
mysqldump $M2SETUP_DB_NAME > /dump.sql
gzip /dump.sql

[ -d /var/lib/mysql ] && rm -rf /var/lib/mysql
